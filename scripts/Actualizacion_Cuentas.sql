DROP TABLE CUENTAS;
CREATE TABLE CUENTAS AS 
(SELECT X.ORIGEN , X.CUENTA,X.CUSTOMER_ID,UPPER(Z.ZONAL)REGION,X.DEPARTAMENTO,X.PROVINCIA,X.DISTRITO,X.ESTADO,X.SERVICIO,X.OBS,X.F_DUMP FROM
(SELECT /*+ parallel(4)*/  D.ATTRIBUTE19 ORIGEN,D.ACCOUNT_NUMBER CUENTA , D.ORIG_SYSTEM_REFERENCE CUSTOMER_ID ,
(CASE WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC)) IN (
'LIMA','AREQUIPA','LA LIBERTAD','CUSCO','PIURA','LAMBAYEQUE','JUNIN','PUNO','CAJAMARCA','ANCASH','ICA','HUANUCO','SAN MARTIN',
'LORETO','AYACUCHO','TACNA','UCAYALI','APURIMAC','MADRE DE DIOS','MOQUEGUA','TUMBES','AMAZONAS','CALLAO','HUANCAVELICA','PASCO') THEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))
      WHEN U.PROVINCIA_CUENTA_DESC IN ('CALLAO','CHINCHA') THEN 'CALLAO'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))='HUÁNUCO' THEN 'HUANUCO'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC)) IN('CUZCO','LA CONVENCION') THEN 'CUSCO' 
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('SAN MARTÍN','LAMAS','MOYOBAMBA') THEN 'SAN MARTIN'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('LA LIBERTADO','LIBERTAD','TRUJILLO','PACASMAYO') THEN 'LA LIBERTAD'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('LAMBAYEQYE') THEN 'LAMBAYEQUE'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('CHACHAPOYAS') THEN 'AMAZONAS'         
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('JUNÍN''HUANACAYO''CHANCHAMAYO','HUANCAYO','JUNIIN','JUNÍN','TARMA','YAULI','JAUJA')THEN 'JUNIN'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('PIURA,PIURA','PARIÑAS') THEN 'PIURA'  
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))='CERRO DE PASCO' THEN 'PASCO'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('ARQUIPA','ARREQUIPA','ISLAY','AQP','AREQUIPÀ','ARERQUIPA') THEN 'AREQUIPA' 
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('LIMA,LIMA','LIM A','LIMA
','HUARAL','CANETE','CAÑETE','SAN ISIDRO','SAN JUAN DE LURIGANCHO','MIRAFLORES','BARRANCO','CALLE LIMA','HUAURA') THEN 'LIMA'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('CAJAMRCA','CAJARMARCA','CAJABAMBA') THEN 'CAJAMARCA'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('AYCUCHO','AYACUHCO') THEN 'AYACUCHO' 
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('APURÍMAC','APURÍAC','ABANCAY','ANDAHUAYLAS','CHINCHEROS ANCO') THEN 'APURIMAC'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN('ANCASH,ANCASH','CHIMBOTE','SANTA','HUARAZ') THEN 'ANCASH'     
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('MADRE DIOS','TAMBOPATA') THEN 'MADRE DE DIOS'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('CHICLAYO') THEN 'LAMBAYEQUE'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('LORTEO','IQUITOS') THEN 'LORETO'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('PISCO') THEN 'ICA'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('ILO') THEN 'MOQUEGUA'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('LAMPA','SAN ROMAN','SAN ANTONIO DE PUTIN') THEN 'PUNO'
      WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('TOCACHE','SAN AMRTIN') THEN 'SAN MARTIN'
        WHEN TRIM(UPPER(U.DEPARTAMENTO_CUENTA_DESC))IN ('HUAJNUCO') THEN 'HUANUCO'
      WHEN TRIM(UPPER(U.PROVINCIA_CUENTA_DESC)) IN (
'LIMA','AREQUIPA','LA LIBERTAD','CUSCO','PIURA','LAMBAYEQUE','JUNIN','PUNO','CAJAMARCA','ANCASH','ICA','HUANUCO','SAN MARTIN',
'LORETO','AYACUCHO','TACNA','UCAYALI','APURIMAC','MADRE DE DIOS','MOQUEGUA','TUMBES','AMAZONAS','CALLAO','HUANCAVELICA','PASCO') THEN TRIM(UPPER(U.PROVINCIA_CUENTA_DESC))
       WHEN TRIM(UPPER(U.DISTRITO_CUENTA_DESC)) IN (
'LIMA','AREQUIPA','LA LIBERTAD','CUSCO','PIURA','LAMBAYEQUE','JUNIN','PUNO','CAJAMARCA','ANCASH','ICA','HUANUCO','SAN MARTIN',
'LORETO','AYACUCHO','TACNA','UCAYALI','APURIMAC','MADRE DE DIOS','MOQUEGUA','TUMBES','AMAZONAS','CALLAO','HUANCAVELICA','PASCO') THEN TRIM(UPPER(U.DISTRITO_CUENTA_DESC))
 ELSE 'LIMA' END)DEPARTAMENTO,
TRIM(UPPER(U.PROVINCIA_CUENTA_DESC)) PROVINCIA,        
(CASE WHEN U.DISTRITO_CUENTA_DESC = 'CERCADO DE LIMA' THEN 'LIMA'
      WHEN U.PROVINCIA_CUENTA_DESC='LIMA' THEN 'LIMA' 
      ELSE TRIM(TRANSLATE(U.DISTRITO_CUENTA_DESC,'ÁáÉéÍíÓóÚú','AaEeIiOoUu'))END)DISTRITO, 
U.ESTADO_CUENTA_DESC ESTADO,
(CASE WHEN D.ATTRIBUTE19 ='SGA' THEN 'FIJO'
      WHEN D.ATTRIBUTE19 <>'SGA' AND F.CUSTOMER_ACCOUNT_SC IS NOT NULL THEN 'FIJO' ELSE 'MOVIL' END)SERVICIO,
       
(CASE WHEN C.TIPO IS NOT NULL THEN C.TIPO
      WHEN D.ATTRIBUTE19 ='SGA' THEN 'FIJO' 
      WHEN D.ATTRIBUTE19 <>'SGA' AND F.CUSTOMER_ACCOUNT_SC IS NOT NULL THEN 'FIJO' ELSE 'MOVIL' END) OBS,
 SYSDATE F_DUMP

FROM DMRED.HZ_CUST_ACCOUNTS@DBL_DWO D,
DWHDS.DS_CUENTAS@DBL_DWO U,
(SELECT CUSTOMER_ACCOUNT_SC ,MAX(AGREEMENT_SERVICE_GROUP) FROM FIJO  GROUP BY CUSTOMER_ACCOUNT_SC) F,
(SELECT CUSTOMER_ACCOUNT_SC, MAX(SUBSCRIPTION_PLATFORM_DESC) TIPO
         FROM FIJO B
        WHERE SUBSCRIPTION_PLATFORM_DESC NOT IN
              ('FIBRA', 'NO_DEFINIDO', 'CDMA', 'CLOUD', 'GSM', 'DTH-PRE')
          AND SUBSCRIPTION_PLATFORM_DESC IS NOT NULL
        GROUP BY CUSTOMER_ACCOUNT_SC)C

WHERE 1=1
AND D.ORIG_SYSTEM_REFERENCE=U.CUENTA_CD(+)
AND D.ORIG_SYSTEM_REFERENCE=F.CUSTOMER_ACCOUNT_SC(+)
AND D.ORIG_SYSTEM_REFERENCE=C.CUSTOMER_ACCOUNT_SC(+))X,
RC_ZONALES Z
WHERE 1=1
AND X.DEPARTAMENTO=Z.DEPARTAMENTO(+));
GRANT SELECT ON CUENTAS TO C26242; 